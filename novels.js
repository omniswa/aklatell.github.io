(function(){'use strict';const savedTheme=localStorage.getItem('reader_theme')||'light';const savedFont=localStorage.getItem('reader_font')||'Newsreader';const savedSize=localStorage.getItem('reader_size')||'medium';const root=document.documentElement;const sizeMap={small:'1rem',medium:'1.125rem',large:'1.3rem'};root.setAttribute('data-theme',savedTheme);root.setAttribute('data-font',savedFont.toLowerCase());root.style.setProperty('--font-size-base',sizeMap[savedSize])})();document.addEventListener('DOMContentLoaded',()=>{const BOOK_ID='book_prog_'+window.location.pathname.split('/').pop();const fragment=document.createDocumentFragment();const progressContainer=document.createElement('div');progressContainer.id='progress-container';const progressBar=document.createElement('div');progressBar.id='progress-bar';progressContainer.appendChild(progressBar);fragment.appendChild(progressContainer);const uiControls=document.createElement('div');uiControls.className='ui-controls';const createFab=(id,icon,label)=>{const btn=document.createElement('button');btn.className='btn-fab';btn.id=id;btn.setAttribute('aria-label',label);btn.innerHTML=icon;return btn};const icons={home:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,share:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>`,settings:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`};const homeBtn=createFab('home-btn',icons.home,'Home');const shareBtn=createFab('share-btn',icons.share,'Share');const settingsBtn=createFab('settings-toggle',icons.settings,'Settings');homeBtn.addEventListener('click',()=>window.location.href='../index.html');shareBtn.addEventListener('click',async()=>{try{if(navigator.share){await navigator.share({title:document.title,url:window.location.href})}else{await navigator.clipboard.writeText(window.location.href);alert('Link copied!')}}catch(err){console.log('Share failed',err)}});uiControls.append(homeBtn,shareBtn,settingsBtn);fragment.appendChild(uiControls);const settingsPanel=document.createElement('div');settingsPanel.className='settings-panel';settingsPanel.innerHTML=`
    <div class="setting-group"><span class="setting-label">THEME</span>
      <div class="theme-toggles">
        <button class="theme-btn" data-val="light">Light</button>
        <button class="theme-btn" data-val="sepia">Sepia</button>
        <button class="theme-btn" data-val="dark">Dark</button>
      </div>
    </div>
    <div class="setting-group"><span class="setting-label">FONT</span>
      <div class="font-toggles">
        <button class="font-btn" data-val="Arial">Sans</button>
        <button class="font-btn" data-val="Spectral">Serif</button>
        <button class="font-btn" data-val="Domine">Bold</button>
      </div>
    </div>
    <div class="setting-group"><span class="setting-label">SIZE</span>
      <div class="size-toggles">
        <button class="size-btn" data-val="small">A-</button>
        <button class="size-btn" data-val="medium">A</button>
        <button class="size-btn" data-val="large">A+</button>
      </div>
    </div>
    <div class="setting-group">
      <button class="btn-ghost" id="reset-progress" style="width:100%">Reset Progress</button>
    </div>
  `;fragment.appendChild(settingsPanel);const toast=document.createElement('div');toast.className='toast';toast.innerHTML=`<span>Resume reading?</span><div class="toast-actions"><button class="btn-ghost" id="toast-no">No</button><button class="btn-primary" id="toast-yes">Yes</button></div>`;fragment.appendChild(toast);document.body.appendChild(fragment);const state={theme:localStorage.getItem('reader_theme')||'light',font:localStorage.getItem('reader_font')||'Arial',size:localStorage.getItem('reader_size')||'medium'};const updateUI=()=>{document.documentElement.setAttribute('data-theme',state.theme);document.documentElement.setAttribute('data-font',state.font.toLowerCase());const sizeMap={small:'1rem',medium:'1.125rem',large:'1.3rem'};document.documentElement.style.setProperty('--font-size-base',sizeMap[state.size]);document.querySelectorAll('.theme-btn').forEach(b=>b.classList.toggle('active',b.dataset.val===state.theme));document.querySelectorAll('.font-btn').forEach(b=>b.classList.toggle('active',b.dataset.val===state.font));document.querySelectorAll('.size-btn').forEach(b=>b.classList.toggle('active',b.dataset.val===state.size));localStorage.setItem('reader_theme',state.theme);localStorage.setItem('reader_font',state.font);localStorage.setItem('reader_size',state.size);calculateDocHeight()};settingsPanel.addEventListener('click',(e)=>{if(e.target.classList.contains('theme-btn')){state.theme=e.target.dataset.val;updateUI()}
if(e.target.classList.contains('font-btn')){state.font=e.target.dataset.val;updateUI()}
if(e.target.classList.contains('size-btn')){state.size=e.target.dataset.val;updateUI()}});settingsBtn.addEventListener('click',(e)=>{e.stopPropagation();settingsPanel.classList.toggle('active')});document.addEventListener('click',(e)=>{if(!settingsPanel.contains(e.target)&&e.target!==settingsBtn){settingsPanel.classList.remove('active')}});let docHeight=0;let lastScrollTop=0;function calculateDocHeight(){docHeight=document.documentElement.scrollHeight-window.innerHeight}
const resizeObserver=new ResizeObserver(()=>{calculateDocHeight()});resizeObserver.observe(document.body);const handleScroll=()=>{const scrollTop=window.scrollY;const progress=docHeight>0?(scrollTop/docHeight)*100:0;progressBar.style.width=Math.min(progress,100)+'%';if(scrollTop>lastScrollTop&&scrollTop>100){uiControls.classList.add('hidden');settingsPanel.classList.remove('active')}else{uiControls.classList.remove('hidden')}
lastScrollTop=Math.max(0,scrollTop);clearTimeout(window.saveTimeout);window.saveTimeout=setTimeout(()=>{localStorage.setItem(BOOK_ID,progress)},500)};window.addEventListener('scroll',()=>requestAnimationFrame(handleScroll),{passive:!0});const savedProgress=parseFloat(localStorage.getItem(BOOK_ID));if(savedProgress>0){setTimeout(()=>toast.classList.add('visible'),500);document.getElementById('toast-yes').addEventListener('click',()=>{calculateDocHeight();const target=(savedProgress/100)*docHeight;window.scrollTo({top:target,behavior:'smooth'});toast.classList.remove('visible')});document.getElementById('toast-no').addEventListener('click',()=>{toast.classList.remove('visible')})}
document.getElementById('reset-progress').addEventListener('click',()=>{localStorage.removeItem(BOOK_ID);window.scrollTo({top:0,behavior:'smooth'});settingsPanel.classList.remove('active')});updateUI()})